{% extends "base.html" %}

{% block title %}Orders - Spell Fulfillment{% endblock %}

{% block content %}
<div class="space-y-6" x-data="ordersPage()">
    <div class="flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-800">Orders</h1>
        <button
            @click="syncOrders()"
            :disabled="syncing"
            class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50"
        >
            <svg class="w-5 h-5 mr-2" :class="{ 'animate-spin': syncing }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            <span x-text="syncing ? 'Syncing...' : 'Sync Orders'"></span>
        </button>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow p-4">
        <div class="flex flex-wrap gap-4">
            <select x-model="filters.status" @change="loadOrders()" class="px-4 py-2 border border-gray-300 rounded-md">
                <option value="">All Statuses</option>
                <option value="pending">Pending</option>
                <option value="generating">Generating</option>
                <option value="review">In Review</option>
                <option value="approved">Approved</option>
                <option value="delivered">Delivered</option>
                <option value="failed">Failed</option>
            </select>
        </div>
    </div>

    <!-- Orders Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Spell Type</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                <template x-if="loading">
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500">Loading...</td>
                    </tr>
                </template>
                <template x-if="!loading && orders.length === 0">
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500">No orders found</td>
                    </tr>
                </template>
                <template x-for="order in orders" :key="order.id">
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-sm font-medium text-gray-900" x-text="'#' + order.etsy_receipt_id"></span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-sm text-gray-900" x-text="order.customer_name || 'Unknown'"></span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-sm text-gray-500" x-text="order.raw_spell_type || '-'"></span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span
                                class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                                :class="getStatusClass(order.status)"
                                x-text="order.status"
                            ></span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="formatDate(order.created_at)"></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <a :href="'/orders/' + order.id" class="text-blue-600 hover:text-blue-900">View</a>
                        </td>
                    </tr>
                </template>
            </tbody>
        </table>

        <!-- Pagination -->
        <div class="bg-gray-50 px-6 py-3 flex items-center justify-between border-t border-gray-200">
            <div class="text-sm text-gray-500">
                Showing <span x-text="((page - 1) * perPage) + 1"></span> to
                <span x-text="Math.min(page * perPage, total)"></span> of
                <span x-text="total"></span> orders
            </div>
            <div class="flex gap-2">
                <button
                    @click="page--; loadOrders()"
                    :disabled="page <= 1"
                    class="px-3 py-1 border rounded-md disabled:opacity-50"
                >Previous</button>
                <button
                    @click="page++; loadOrders()"
                    :disabled="page >= pages"
                    class="px-3 py-1 border rounded-md disabled:opacity-50"
                >Next</button>
            </div>
        </div>
    </div>
</div>

<script>
    function ordersPage() {
        return {
            orders: [],
            loading: true,
            syncing: false,
            page: 1,
            perPage: 20,
            total: 0,
            pages: 0,
            filters: {
                status: new URLSearchParams(window.location.search).get('status') || ''
            },

            async init() {
                await this.loadOrders();
            },

            async loadOrders() {
                this.loading = true;
                const token = localStorage.getItem('token');

                try {
                    const params = new URLSearchParams({
                        page: this.page,
                        per_page: this.perPage
                    });
                    if (this.filters.status) params.append('status', this.filters.status);

                    const response = await fetch(`/api/v1/orders?${params}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.status === 401) {
                        window.location.href = '/login';
                        return;
                    }

                    const data = await response.json();
                    this.orders = data.items;
                    this.total = data.total;
                    this.pages = data.pages;
                } catch (err) {
                    console.error('Failed to load orders:', err);
                } finally {
                    this.loading = false;
                }
            },

            async syncOrders() {
                this.syncing = true;
                const token = localStorage.getItem('token');

                try {
                    const response = await fetch('/api/v1/orders/sync', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await response.json();
                    alert(`Sync complete! ${data.new_orders} new orders found.`);
                    await this.loadOrders();
                } catch (err) {
                    alert('Failed to sync orders: ' + err.message);
                } finally {
                    this.syncing = false;
                }
            },

            getStatusClass(status) {
                const classes = {
                    pending: 'bg-yellow-100 text-yellow-800',
                    generating: 'bg-blue-100 text-blue-800',
                    review: 'bg-purple-100 text-purple-800',
                    approved: 'bg-green-100 text-green-800',
                    delivered: 'bg-gray-100 text-gray-800',
                    failed: 'bg-red-100 text-red-800'
                };
                return classes[status] || 'bg-gray-100 text-gray-800';
            },

            formatDate(dateStr) {
                return new Date(dateStr).toLocaleDateString();
            }
        }
    }
</script>
{% endblock %}
