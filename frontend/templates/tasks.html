{% extends "base.html" %}

{% block title %}Tasks - Spell Fulfillment{% endblock %}

{% block content %}
<div class="space-y-6" x-data="tasksPage()">
    <div class="flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-800">Tasks</h1>
        <button
            @click="showCreateModal = true"
            class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
        >
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            New Task
        </button>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow p-4">
        <div class="flex flex-wrap gap-4">
            <select x-model="filters.status" @change="loadTasks()" class="px-4 py-2 border border-gray-300 rounded-md">
                <option value="">All Statuses</option>
                <option value="pending">Pending</option>
                <option value="in_progress">In Progress</option>
                <option value="completed">Completed</option>
            </select>
            <select x-model="filters.priority" @change="loadTasks()" class="px-4 py-2 border border-gray-300 rounded-md">
                <option value="">All Priorities</option>
                <option value="urgent">Urgent</option>
                <option value="high">High</option>
                <option value="medium">Medium</option>
                <option value="low">Low</option>
            </select>
        </div>
    </div>

    <!-- Tasks List -->
    <div class="bg-white rounded-lg shadow">
        <template x-if="loading">
            <div class="p-6 text-center text-gray-500">Loading...</div>
        </template>
        <template x-if="!loading && tasks.length === 0">
            <div class="p-6 text-center text-gray-500">No tasks found</div>
        </template>
        <ul class="divide-y divide-gray-200">
            <template x-for="task in tasks" :key="task.id">
                <li class="p-4 hover:bg-gray-50">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <button
                                @click="toggleComplete(task)"
                                class="w-6 h-6 rounded-full border-2 flex items-center justify-center"
                                :class="task.status === 'completed' ? 'bg-green-500 border-green-500' : 'border-gray-300 hover:border-green-500'"
                            >
                                <svg x-show="task.status === 'completed'" class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </button>
                            <div>
                                <p
                                    class="font-medium"
                                    :class="task.status === 'completed' ? 'text-gray-400 line-through' : 'text-gray-900'"
                                    x-text="task.title"
                                ></p>
                                <p class="text-sm text-gray-500" x-text="task.description || ''"></p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span
                                class="px-2 py-1 text-xs font-medium rounded"
                                :class="getPriorityClass(task.priority)"
                                x-text="task.priority"
                            ></span>
                            <span x-show="task.due_date" class="text-sm text-gray-500" x-text="formatDate(task.due_date)"></span>
                            <button @click="deleteTask(task)" class="text-red-500 hover:text-red-700">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </li>
            </template>
        </ul>
    </div>

    <!-- Create Task Modal -->
    <div x-show="showCreateModal" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6">
            <h2 class="text-xl font-bold mb-4">Create Task</h2>
            <form @submit.prevent="createTask()">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                        <input type="text" x-model="newTask.title" required class="w-full px-4 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea x-model="newTask.description" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-md"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Task Type</label>
                        <select x-model="newTask.task_type_id" required class="w-full px-4 py-2 border border-gray-300 rounded-md">
                            <template x-for="type in taskTypes" :key="type.id">
                                <option :value="type.id" x-text="type.name"></option>
                            </template>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                        <select x-model="newTask.priority" class="w-full px-4 py-2 border border-gray-300 rounded-md">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Due Date (optional)</label>
                        <input type="datetime-local" x-model="newTask.due_date" class="w-full px-4 py-2 border border-gray-300 rounded-md">
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" @click="showCreateModal = false" class="px-4 py-2 border border-gray-300 rounded-md">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Create</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function tasksPage() {
        return {
            tasks: [],
            taskTypes: [],
            loading: true,
            showCreateModal: false,
            filters: { status: '', priority: '' },
            newTask: { title: '', description: '', task_type_id: null, priority: 'medium', due_date: '' },

            async init() {
                await this.loadTaskTypes();
                await this.loadTasks();
            },

            async loadTaskTypes() {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/v1/tasks/types', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                this.taskTypes = data.items;
                if (this.taskTypes.length > 0) {
                    this.newTask.task_type_id = this.taskTypes[0].id;
                }
            },

            async loadTasks() {
                this.loading = true;
                const token = localStorage.getItem('token');

                try {
                    const params = new URLSearchParams();
                    if (this.filters.status) params.append('status', this.filters.status);
                    if (this.filters.priority) params.append('priority', this.filters.priority);

                    const response = await fetch(`/api/v1/tasks?${params}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await response.json();
                    this.tasks = data.items;
                } finally {
                    this.loading = false;
                }
            },

            async createTask() {
                const token = localStorage.getItem('token');

                // Prepare payload, converting empty due_date to null
                const payload = { ...this.newTask };
                if (!payload.due_date) {
                    delete payload.due_date;
                }

                await fetch('/api/v1/tasks', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                this.showCreateModal = false;
                this.newTask = { title: '', description: '', task_type_id: this.taskTypes[0]?.id, priority: 'medium', due_date: '' };
                await this.loadTasks();
            },

            async toggleComplete(task) {
                const token = localStorage.getItem('token');
                if (task.status === 'completed') {
                    await fetch(`/api/v1/tasks/${task.id}`, {
                        method: 'PUT',
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: 'pending' })
                    });
                } else {
                    await fetch(`/api/v1/tasks/${task.id}/complete`, {
                        method: 'PATCH',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                }
                await this.loadTasks();
            },

            async deleteTask(task) {
                if (!confirm('Delete this task?')) return;
                const token = localStorage.getItem('token');
                await fetch(`/api/v1/tasks/${task.id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                await this.loadTasks();
            },

            getPriorityClass(priority) {
                return {
                    urgent: 'bg-red-100 text-red-800',
                    high: 'bg-orange-100 text-orange-800',
                    medium: 'bg-blue-100 text-blue-800',
                    low: 'bg-gray-100 text-gray-800'
                }[priority] || 'bg-gray-100 text-gray-800';
            },

            formatDate(dateStr) {
                return new Date(dateStr).toLocaleDateString();
            }
        }
    }
</script>
{% endblock %}
